#include <math.h>
#include <stdio.h>
#include <stdint.h>

int log2_8(uint32_t x) {
    int base;
    asm("clz %0, %1" : "=r" (base) : "r" (x));
    asm("shl %0, %1, %2" : "=r" (x) : "r" (x), "r" (base-28));  // do not use >> relies on negative shifts.
    asm("zext %0, 3" : "+r" (x));
    return x + ((31-base)<<3);
}

struct {int adder, multiplier; } xxx[] = {
    {-1466,2932},
    {-1443,2887},
    {-1421,2844},
    {-1399,2802},
    {-1377,2761},
    {-1356,2721},
    {-1335,2683},
    {-1314,2645},
    {-1293,2609},
    {-1273,2573},
    {-1253,2539},
    {-1233,2505},
    {-1214,2472},
    {-1195,2440},
    {-1176,2409},
    {-1157,2379},
    {-1139,2349},
    {-1120,2320},
    {-1102,2292},
    {-1085,2265},
    {-1067,2238},
    {-1050,2212},
    {-1032,2186},
    {-1015,2161},
    {-999,2137},
    {-982,2113},
    {-966,2090},
    {-949,2067},
    {-933,2044},
    {-917,2023},
    {-902,2001},
    {-886,1980},
    {-871,1960},
    {-856,1940},
    {-840,1920},
    {-826,1901},
    {-811,1882},
    {-796,1863},
    {-782,1845},
    {-767,1827},
    {-753,1810},
    {-739,1793},
    {-725,1776},
    {-711,1759},
    {-698,1743},
    {-684,1727},
    {-671,1711},
    {-657,1696},
    {-644,1681},
    {-631,1666},
    {-618,1652},
    {-605,1637},
    {-592,1623},
    {-580,1609},
    {-567,1596},
    {-555,1583},
    {-543,1569},
    {-530,1556},
    {-518,1544},
    {-506,1531},
    {-494,1519},
    {-483,1507},
    {-471,1495},
    {-459,1483},
    {-46913,750624},
    {-46186,739163},
    {-45469,728046},
    {-44764,717258},
    {-44068,706786},
    {-43383,696615},
    {-42708,686733},
    {-42042,677127},
    {-41385,667786},
    {-40737,658699},
    {-40098,649857},
    {-39468,641248},
    {-38846,632865},
    {-38232,624698},
    {-37626,616739},
    {-37027,608981},
    {-36436,601415},
    {-35852,594035},
    {-35276,586833},
    {-34706,579805},
    {-34143,572942},
    {-33587,566241},
    {-33037,559694},
    {-32494,553297},
    {-31956,547044},
    {-31425,540931},
    {-30900,534953},
    {-30380,529106},
    {-29866,523386},
    {-29358,517788},
    {-28855,512308},
    {-28357,506943},
    {-27865,501689},
    {-27377,496543},
    {-26895,491502},
    {-26417,486561},
    {-25945,481720},
    {-25477,476973},
    {-25013,472319},
    {-24554,467755},
    {-24099,463279},
    {-23649,458887},
    {-23203,454578},
    {-22761,450349},
    {-22323,446198},
    {-21890,442123},
    {-21460,438122},
    {-21034,434192},
    {-20612,430332},
    {-20193,426540},
    {-19779,422815},
    {-19368,419154},
    {-18960,415556},
    {-18556,412019},
    {-18155,408542},
    {-17758,405123},
    {-17364,401760},
    {-16973,398453},
    {-16586,395201},
    {-16201,392000},
    {-15820,388851},
    {-15442,385753},
    {-15067,382703},
    {-14694,379701},
};


int log2_16(uint32_t x) {
    int base;
    int lookup;
    asm("clz %0, %1" : "=r" (base) : "r" (x));
    asm("shl %0, %1, %2" : "=r" (lookup) : "r" (x), "r" (base-25));
    asm("shl %0, %1, %2" : "=r" (x) : "r" (x), "r" (base-16));
    asm("zext %0, 6" : "+r" (lookup));
    int log_multiplier = xxx[lookup].multiplier;
    int log_adder = xxx[lookup].adder;
    return log_adder + ((log_multiplier * x) >> 16) + ((31-base)<<10);
}

int log2_8_64(uint64_t x) {
    int base;
    uint32_t y;
    asm("clz %0, %1" : "=r" (base) : "r" ((int32_t)(x >> 32)));
    base = 32-base;
    if (base <= 0) {
        return log2_8((uint32_t)x);
    }
    asm("lextract %0, %1, %2, %3, 32" : "=r" (y) : "r" ((int32_t)(x >> 32)), "r" ((uint32_t)x), "r" (base));
    return log2_8(y) + base;
}

int log2_16_64(uint64_t x) {
    int base;
    uint32_t y;
    asm("clz %0, %1" : "=r" (base) : "r" ((int32_t)(x >> 32)));
    base = 32-base;
    if (base <= 0) {
        return log2_16((uint32_t)x);
    }
    asm("lextract %0, %1, %2, %3, 32" : "=r" (y) : "r" ((int32_t)(x >> 32)), "r" ((uint32_t)x), "r" (base));
    return log2_16(y) + base;
}

#ifdef LOCAL_LOG_MAIN

int main(void) {
    for(int i = 1000; i < 0*(1<<30); i = i * 2 + 834) {
        printf("%d: %d %f\n", i, log2_8(i), log((float)i)/log(2.0)*8);
    }
    for(int i = 1000; i < (1<<30); i = i * 2 + 834) {
        printf("%d: %d %f\n", i, log2_16(i), log((float)i)/log(2.0)*8*128);
    }
}

#endif
        
